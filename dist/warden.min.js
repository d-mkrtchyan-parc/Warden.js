!function(a,b){"object"==typeof exports&&exports?b(exports):(null==a.Warden&&(Warden={}),b(Warden),"function"==typeof define&&define.amd?define(Warden):a.Warden=Warden)}(this,function(a){"use strict";function b(a,b){var c=b||[],d=b&&b.length||0;this.length=function(){return d},this.push=function(b){d>=a&&c.shift(),c.push(b),d=c.length},this.get=function(a){return f(a)?c[a]:c}}function c(a,b){var c=a||[],d=0,e=0,f=this;this.getProcesses=function(){return c};var g=[function(a){return f.tick(a)},function(){return f.tick({},1)},function(){return d=1},function(){return d=0},function(){return f.hoster}];this.hoster=b,this.start=function(a,b,h){return f.ctx=b,f.fin=h,d&&(e=0),e==c.length?(e=0,h(a)):(i(g,function(a){f.ctx[a.name]=a}),void this.tick(a))},this.tick=function(a,b){return b?void(e=0):e==c.length?(i(g,function(a){delete f.ctx[a.name]}),e=0,f.fin(a)):(e++,void c[e-1].apply(f.ctx,[a]))}}function d(a){var b=[];return this.eval=function(c){b.forEach(function(b){b.fire(c,a)})},this.push=function(a){b.push(a)},this.pop=function(a){i(b,function(c,d){a==c&&(b=b.slice(0,d).concat(b.slice(d+1,b.length)))})},this.get=function(){var a=new e;return a.host(this),a},this}function e(a){var d=new c(a||[],this),g=0;this.id=1e9*Math.random()>>0,this.parent=null,this._={fires:new b,takes:new b,skipped:0},this.host=function(a){return g=a||g},this.process=function(a){var b,c;return a?(b=[],i(d.getProcesses(),function(a){b.push(a)}),b.push(a),c=new e(b),c.host(this.host()),c.parent=this.parent||this,c):d},this.fire=function(a,b){var c=this;a=f(a)?a:{},a.$$bus=this,this._.fires.push(a),d.start(a,b,function(a){c._.takes.push(a),c.handler.apply(b,[a])})}}a.version="0.0.3.1",a.log=function(a){console.log(a)};var f=function(a){return"undefined"!=typeof a&&null!==a},g={fn:function(a){return"function"==typeof a},num:function(a){return"number"==typeof a},str:function(a){return"string"==typeof a},array:function(a){return h(a)},obj:function(a){return"object"==typeof a},exists:function(a){return f(a)},map:{_function:function(a){return g.fn(a)},_number:function(a){return g.num(a)},_string:function(a){return g.str(a)},_array:function(a){return g.arr(a)},_object:function(a){return g.obj(a)}}},h=function(){return Array.isArray?function(a){return Array.isArray(a)}:function(a){"[object Array]"===Object.prototype.toString.call(a)}}(),i=function(){return Array.prototype.forEach?function(a,b){return a?a.forEach(b):null}:function(a,b){for(var c=0,d=a.length;d>c;c++)b(a[c],c)}}(),j=(function(){return Array.prototype.filter?function(a,b){return a?a.filter(b):null}:function(a,b){for(var c=[],d=0,e=a.length;e>d;d++){var f=b(a[d]);f===!0&&c.push(f)}return c}}(),function(a,b,c){var d={};if(j.MAP[a][b](typeof c))return["number","string","function","object","array"].forEach(function(a){d["_"+a]=function(b){return g.map["_"+a](c)&&b(),d}}),d;throw"TypeError: unexpected type of argument at : "+a+" : "+b});j.MAP={Warden:{makeStream:function(a){return"string"==a||"function"==a}}},a.extend=function(b,c){var d=c||{max:512,context:"this",emitter:null,listener:null},e=typeof b,f=b,g=!0;switch(e){case"function":f=b.prototype,g=!0;break;case"object":g=!1}"undefined"!=typeof jQuery?(d.emitter=d.emitter||"trigger",d.listener=d.listener||"on"):("function"==typeof f.addEventListener||"function"==typeof f.attachEvent)&&(d.listener=d.listener||("function"==typeof f.addEventListener?"addEventListener":"attachEvent"));var h=[];return h.setNewHandler=function(a,b,c){var e=this.getHandlers(a,b);if(e){if(!(e.length<d.max))throw"Maximal handlers count reached";e=e.push(c)}else{var f=this.getCollection(a);f?(f.handlers[b]=f.handlers[b]||[],f.handlers[b].push(c)):(f={},f.object=a,f.handlers={},f.handlers[b]=[c],this.push(f))}},h.getCollection=function(a){for(var b=this.length-1;b>=0;b--)if(this[b].object===a)return this[b];return!1},h.getHandlers=function(a,b){for(var c=this.length-1;c>=0;c--)if(this[c].object===a)return this[c].handlers[b];return!1},f.emit=function(a){var b=this,c=h.getHandlers(this,a.type);return i(c,function(c){c.call(b,a)}),this},f.listen=function(a,b){var c=this;return h.setNewHandler(this,a,b),this[d.listener]&&this[d.listener].apply(this,[a,function(a){c.emit(a)}]),this},f.stream=function(b,c){var e=a.makeStream(b,c||this);return h.setNewHandler(this,b,function(a){e.eval(a)}),this[d.listener]&&this[d.listener].apply(this,[b,function(a){e.eval(a)}]),e.get()},b},a.makeStream=function(a,b){var c,e;return j("Warden","makeStream",a)._string(function(){c=new d(b)})._function(function(){c=new d(b),e=a.toString(),i(["eval","pop","push","get"],function(a){e.indexOf("this."+a)>=0&&console.warn("You have used reserved word '"+a+"' in stream")}),a.apply(c,[function(a){c.eval(a)}])}),c},e.prototype.listen=function(a){var b=this.clone();return b.handler=g.fn(a)?a:function(){console.log(a)},this.host().push(b),b},e.prototype.log=function(){return this.listen(function(a){return console.log(a)})},e.prototype.clone=function(){var a=new e(this.process().getProcesses());return a.parent=this.parent||this,a.host(this.host()),a},e.prototype.filter=function(a){if(!g.fn(a))throw"TypeError: filter argument mus be a function";return this.process(function(b){return a(b)===!0?this.$continue(b):this.$break()})},e.prototype.map=function(a){var b,c=typeof a;switch(c){case"function":b=function(b){return this.$continue(a.apply(this,[b]))};break;case"string":b=function(b){var c=b[a],d=f(c)?c:a;return this.$host()._.fires.get()[this.$host()._.fires.length()-1]=d,this.$continue(d)};break;case"object":b=h(a)?function(b){var c=[];return i(a,function(a){var d=b[a];c.push(f(d)?d:a)}),this.$continue(c)}:function(b){var c,d={};for(var e in a)c=b[a[e]],d[e]=f(c)?c:a[e];return this.$continue(e)};break;default:b=function(){return this.$continue(a)}}return this.process(b)},e.prototype.reduce=function(a,b){if(g.fn(b))return this.process(function(c){var d=this.$host(),e=a;if("-f"===a)var e=d._.takes.get(d._.takes.length());return this.$continue(b(e,next))});throw"TypeError: second argument must be a function"},e.prototype.take=function(a){if(g.fn(a))return this.filter(a);if(g.num(a))return this.process(function(b){var c=this.$host();return c._.limit=c._.limit||a,c._.takes.length()===c._.limit?this.$break():this.$continue(b)});throw"TypeError: take argument must be function or number"},e.prototype.skip=function(a){if(g.num(a))return this.process(function(b){var c=this.$host();return c._.fires.length()<=a?void this.$break():this.$continue(b)});throw"TypeError: skip argument must be only number"},e.prototype.waitFor=function(a){return this.process(function(b){var c=this;return this.$lock(),a.listen(function(){return c.$unlock&&c.$unlock(),c.$continue&&c.$continue(b)})})},e.prototype.mask=function(a){return g.str(a)?this.process(function(b){var c=/{{\s*[\w\.]+\s*}}/g;return this.$continue(a.replace(c,function(a){return b[a.slice(2,-2)]}))}):this.map(a)},e.prototype.debounce=function(a){if(g.num(a))return this.process(function(b){var c=this,d=this.$host();clearTimeout(d._.dbtimer),d._.dbtimer=setTimeout(function(){delete d._.dbtimer,c.$unlock(),c.$continue(b)},a),this.$lock()});throw"TypeError: argument of debounce must be a number of ms."},e.prototype.getCollected=function(a){if(g.num(a))return this.process(function(){var b=this,c=this.$host(),d=c._.fires.length()-1;c._.timer||(c._.collectionStart=d,c._.timer=setTimeout(function(){var a=c._.history.slice(c._.collectionStart,d);delete c._.timer,b.$unlock(),b.$continue(a)},a),this.$lock())});throw"TypeError: getCollected of debounce must be a number of ms."},e.prototype.merge=function(b){var c=this;return a.makeStream(function(a){b.listen(a),c.listen(a)}).get()},e.prototype.combine=function(b,c){var d=this;return a.makeStream(function(a){d.listen(function(d){a(c(d,b._.fires.get(b._.fires.length()-1)))}),b.listen(function(b){a(c(d._.fires.get(d._.fires.length()-1),b))})}).get()},e.prototype.sync=function(b){var c=this;return a.makeStream(function(a){var d,e,f=!1,g=!1,h=function(){d=null,e=null,f=!1,g=!1};b.listen(function(b){f?(a([d,b]),h()):(e=b,g=!0)}),c.listen(function(b){g?(a([b,e]),h()):(d=b,f=!0)})}).get()},e.prototype.lock=function(){this.host().pop(this)},e.prototype.unlock=function(){this.host().push(this)},e.prototype.bindTo=function(){{var b=arguments;Array.prototype.concat}unshift.apply(b,[this]),a.watcher(b)},e.prototype.once=function(){return this.take(1)},e.prototype.unique=function(){return this.process(function(a){var b=this.$host()._.fires,c=this.$host()._.takes;return!(b.length()>1||c.length()>0)||a!=b.get(b.length()-2)&&a!=c.get(c.length()-1)?this.$continue(a):this.$break()})},a.watcher=function(a,b,c){var d=arguments.length,e=null;if(3==d)if(g.fn(c)){if(!g.obj(b))throw"Wrong";e=function(a){return b=c(a)}}else{if(!g.str(c))throw"Wrong";if(!g.obj(b))throw"Wrong";e=function(a){return b[c]=a}}else if(2==d)e=function(a){b=a};else if(1==d)throw"Wrong";return a.listen(e)}});
!function(a,b){"object"==typeof exports&&exports?b(exports):(null==a.Warden&&(Warden={}),b(Warden),"function"==typeof define&&define.amd?define(Warden):a.Warden=Warden)}(this,function(a){function b(b,f){var g={maxTakenLength:f&&f.maxTakenLength||64,maxHistoryLength:f&&f.maxHistoryLength||64,context:f&&f.context||null},h=function(){function a(a){return{busIsDeprecated:!0,deprecationFn:a}}var b={};return b.m=function(a,b){var e=a.fn;if("function"==typeof e)b=e.apply(g.context,[b]);else if("string"==typeof e&&void 0!=b[e])b=b[e];else if(c(e))b=d(e,function(a){return"string"==typeof a&&void 0!==b[a]?b[a]:void 0});else if("object"==typeof e){var f={};for(var h in e){{e[h]}f[h]=b[e[h]]}b=f}else b=e;return this.mapped=!0,b},b.f=function(b,c){var d=b.fn;if("function"==typeof d){if(d.apply(g.context,[c])===!1)return a("filter")}else if(Boolean(d)===!1)return derprecate("filter");return this.filtered=!0,c},b.i=function(a,b){var e=a.fn,f=this;return c(e)?d(e,function(a){if("string"!=typeof a)throw"Unexpected "+typeof a+" at inclide";null!=this._public[a]&&(b[a]=f._public[a])}):null!=this._public[e]&&(b[e]=f._public[e]),b},b.r=function(a,b){var c,d=a.fn;return c=this.taken.length>0?this.taken[this.taken.length-1]:"first"==a.start?b:a.start,b=d.apply(g.context,[c,b])},b.u=function(b,c){if(this.taken.length){var d=this.taken[this.taken.length-1][b.prop];if(d){if(c[b.prop]==d)return a("unique")}else if(c[b.prop]==this.history[this.history.length-1][b.prop])return a("unique")}return c},b}(),i=function(){function b(a){this.process=null!=a?a:[],this._public={skipped:0,taken:0,limit:0,length:0,ignore:0},this.history=[],this.taken=[]}return b.prototype.exec=function(a,b){if(this.locked)return!1;var c=a;this._public.length++,c.timestamp=(new Date).getTime();for(var d=0,e=this.process.length;e>d;d++){var f=this.process[d],i=h[f.type].apply(this,[f,c]);if(i.busIsDeprecated)return!1;c=i}return this.history.length>=g.maxHistoryLength&&this.history.shift(0),this.history.push(a),this._public.limit&&this._public.taken>=this._public.limit?!1:this._public.length<=this._public.ignore?(this._public.skipped++,!1):(this._public.taken++,this.taken.length>=g.maxTakenLength&&this.taken.shift(0),this.taken.push(c),this.connector?this.connector.locked?console.log("locked"):this.connector.assign(c):this.finalCallback.apply(g.context||b,[c]),this)},b.prototype.toString=function(){return a.stringify(this.process)},b.prototype.map=function(a){var c=new b(this.process.concat({type:"m",fn:a}));return c._public=this._public,c},b.prototype.filter=function(a){var c=new b(this.process.concat({type:"f",fn:a}));return c._public=this._public,c},b.prototype.include=function(a){var c=new b(this.process.concat({type:"i",fn:a}));return c._public=this._public,c},b.prototype.reduce=function(a,c){var d=new b(this.process.concat({type:"r",fn:c,start:a}));return d._public=this._public,d},b.prototype.take=function(a,c){if("function"==typeof a)return this.filter(a);var d=new b(this.process);if(null!=c){if("number"==typeof c)return d.skip(a).take(c-a);throw"Type Error: take method expect number at second argumner;"}this.limit=a,this._public.limit=a;var e=this._public;return d._public=e,d._public.limit=a,d.limit=a,d},b.prototype.skip=function(a){if("number"!=typeof a)throw"Type Error: skip method expect numbers;";var c=new b(this.process),d=this._public;return c._public=d,c._public.ignore=a,this._public.ignore=a,c},b.prototype.unique=function(a){var c=new b(this.process.concat({type:"u",prop:a}));return c._public=this._public,c},b.prototype.lock=function(){this.locked=!0},b.prototype.unlock=function(){this.locked=!1},b.prototype.listen=function(a){return this.finalCallback="log"===a?function(a){console.log(a)}:a,j.activeBus.push(this),this},b.prototype.log=function(){return this.listen(function(a){console.log(a)})},b.prototype.evaluate=function(a,b){return j.activeBus.map(function(c){return c.exec(a,b)})},b.prototype.connect=function(a,b){var c=new e(a,b,this);return this.connector=c,j.activeBus.push(this),this.connector},b}(),j={type:b,activeBus:[]};return new i}{var c=function(){return Array.isArray?function(a){return Array.isArray(a)}:function(a){"[object Array]"===Object.prototype.toString.call(a)}}(),d=function(){return Array.prototype.forEach?function(a,b){return a?a.forEach(b):null}:function(a,b){for(var c=0,d=a.length;d>c&&b(a[c],c)!==!1;c++);}}();!function(){return Array.prototype.filter?function(a,b){return a?a.filter(b):null}:function(a,b){for(var c=[],d=0,e=a.length;e>d;d++){var f=b(a[d]);f===!0&&c.push(f)}return c}}()}a.version="0.0.1",a.toString=function(){return"Warden.js"},a.extend=function(a,c){var e=typeof a,f=a,g=!0;switch(e){case"function":f=a.prototype,g=!0;break;case"object":g=!1}var h={max:c&&c.max||128,context:c&&c.context||"this"};g?(h.nativeEmitter=null,h.nativeListener=null):(h.nativeEmitter=c&&c.nativeEmitter||("undefined"==typeof jQuery?null:"trigger"),h.nativeListener=c&&c.nativeListener||("undefined"==typeof jQuery?"addEventListener":"on"));var i=[];return i.items=[],i.create=function(a){return this.push(a),this.items.push({handlers:{},streams:{}}),this.items[this.length-1]},i.isIn=function(a){for(var b=this.length-1;b>=0;b--)if(this[b]===a)return this.items[b];return[]},f.emit=f.emit||function(a){var b=this,c=i.isIn(this),e=c.streams,f=c.handlers;return d(e[a.type],function(c){return c.evaluate(a,b)}),d(f[a.type],function(c){var d=c.config&&c.config.context||b,e=c.config&&c.config.adj;return c.callback.apply(d,[a].concat(e))}),this},f.listen=f.listen||function(a,b,c){var d=i.isIn(this);if(d.length||i.create(this),handlers=d.handlers,handlers[a]=handlers[a]||[],handlers[a].length>=h.max)throw"The maximum number ("+h.max+") of handler for event ["+a+"] exceed.";return handlers[a].push({callback:b,config:c}),this},f.stream=function(a,c){var d=f[h.nativeListener];d&&("this"==h.context?f[h.nativeListener](a,function(a){f.emit(a)}):d(a,f.emit));var e=null,g=b(a,c),j=i.isIn(this);return j.length?e=j.streams:(j=i.create(this),e=j.streams),e&&null==e[a]&&(e[a]=[]),e[a].push(g),g},a};var e=function(){function a(a,b,c){this.item=a,"function"==typeof b?this.method=b:this.prop=b,this.host=c,this.locked=!1}return a.prototype.assign=function(a){this.method?this.item[this.method](a):this.item[this.prop]=a},a.prototype.unbind=function(){this.locked=!0},a.prototype.bind=function(){this.locked=!1},a}()});
!function(a,b){"object"==typeof exports&&exports?b(exports):(null==a.Warden&&(Warden={}),b(Warden),"function"==typeof define&&define.amd?define(Warden):a.Warden=Warden)}(this,function(a){"use strict";function b(a,b){var c=a||[],d=0,e=0,f=this;this.getProcesses=function(){return c};var g=[function(a){return f.tick(a)},function(){return f.tick({},1)},function(){return d=1},function(){return d=0},function(){return f.hoster}];this.hoster=b,this.start=function(a,b,i){return f.ctx=b,f.fin=i,d&&(e=0),e==c.length?(e=0,i(a)):(h(g,function(a){f.ctx[a.name]=a}),void this.tick(a))},this.tick=function(a,b){return b?void(e=0):e==c.length?(h(g,function(a){delete f.ctx[a.name]}),e=0,f.fin(a)):(e++,void c[e-1].apply(f.ctx,[a]))}}function c(a,b){var c=[];this.drive=[],this.id=1e4*Math.random()>>0;var e=new d;return e.setHost(this),this.eval=function(a){c.forEach(function(c){c.fire(a,b)})},this.push=function(a){c.push(a)},this.get=function(){return e},this}function d(a){var c=new b(a||[],this),e=0;this._={history:[],fired:0,taken:0,skipped:0},this.setHost=function(a){e=a},this.getHost=function(){return e},this.getProcessor=function(){return c},this.addProcess=function(a){var b=[];h(c.getProcesses(),function(a){b.push(a)}),b.push(a);var e=new d(b);return e.setHost(this.getHost()),e},this.fire=function(a,b){var d=this;a=this.setupData(a),this._.fired++,this._.history.push(a),c.start(a,b,function(a){d._.taken++,d.handler.apply(b,[a])})}}a.version="0.0.2",a.log=function(){return void((a.debug||window.debug)&&console.log(arguments))};{var f=function(a){return"undefined"!=typeof a&&null!==a},g=function(){return Array.isArray?function(a){return Array.isArray(a)}:function(a){"[object Array]"===Object.prototype.toString.call(a)}}(),h=function(){return Array.prototype.forEach?function(a,b){return a?a.forEach(b):null}:function(a,b){for(var c=0,d=a.length;d>c;c++)b(a[c],c)}}();!function(){return Array.prototype.filter?function(a,b){return a?a.filter(b):null}:function(a,b){for(var c=[],d=0,e=a.length;e>d;d++){var f=b(a[d]);f===!0&&c.push(f)}return c}}()}a.extend=function(b,c){var d=c||{max:256,context:"this",emitter:null,listener:null},e=typeof b,f=b,g=!0;switch(e){case"function":f=b.prototype,g=!0;break;case"object":g=!1}"undefined"!=typeof jQuery?(d.emitter=d.emitter||"trigger",d.listener=d.listener||"on"):("function"==typeof f.addEventListener||"function"==typeof f.attachEvent)&&(d.listener=d.listener||("function"==typeof f.addEventListener?"addEventListener":"attachEvent"));var i=[];return i.setNewHandler=function(a,b,c){var e=this.getHandlers(a,b);if(e){if(!(e.length<d.max))throw"Maximal handlers count";e=e.push(c)}else{var f=this.getCollection(a);f?(f.handlers[b]=f.handlers[b]||[],f.handlers[b].push(c)):(f={},f.object=a,f.handlers={},f.handlers[b]=[c],this.push(f))}},i.getCollection=function(a){for(var b=this.length-1;b>=0;b--)if(this[b].object===a)return this[b];return!1},i.getHandlers=function(a,b){for(var c=this.length-1;c>=0;c--)if(this[c].object===a)return this[c].handlers[b];return!1},f.emit=function(b){a.log("Emitted "+b.type);var c=this,d=i.getHandlers(this,b.type);return h(d,function(a){a.call(c,b)}),this},f.listen=function(a,b){return i.setNewHandler(this,a,b),this[d.listener]&&this[d.listener].apply(this,[ev,function(a){self.emit(a)}]),this},f.stream=function(b,c){var e=a.makeStream(b,c||this);return i.setNewHandler(this,b,function(a){e.eval(a)}),this[d.listener]&&this[d.listener].apply(this,[b,function(a){e.eval(a)}]),e.get()},b},a.makeStream=function(a,b){var d,e=typeof a;switch(e){case"function":for(var f=0,g="";2>f;f++)g+=(1e5*Math.random()>>0)+"-";d=new c(g.slice(0,-1),b),a(function(a){d.eval(a)});break;case"string":d=new c(a,b);break;default:throw"Unexpected data type at stream\n"}return d},d.prototype.setupData=function(a){return a.timestamp=(new Date).getTime(),a},d.prototype.listen=function(a){var b=this.clone();return b.handler="function"==typeof a?a:function(){console.log(a)},this.getHost().push(b),b},d.prototype.log=function(){return this.listen(function(a){console.log(a)})},d.prototype.clone=function(){var a=new d(this.getProcessor().getProcesses());return a.setHost(this.getHost()),a},d.prototype.filter=function(a){if("function"!=typeof a)throw"TypeError: filter argument mus be a function";return this.addProcess(function(b){return a(b)===!0?this.$continue(b):this.$break()})},d.prototype.map=function(a){var b,c=typeof a;switch(c){case"function":b=function(b){return this.$continue(a.apply(this,[b]))};break;case"string":b=function(b){var c=b[a],d=f(c)?c:a;return this.$host()._.history[this.$host()._.fired-1]=d,this.$continue(d)};break;case"object":b=g(a)?function(b){var c=[];return h(a,function(a){var d=b[a];c.push(f(d)?d:a)}),this.$continue(c)}:function(b){var c,d={};for(var e in a)c=b[a[e]],d[e]=f(c)?c:a[e];return this.$continue(e)};break;default:b=function(){return this.$continue(a)}}return this.addProcess(b)},d.prototype.take=function(a){var b=typeof a;if("function"==b)return this.filter(a);if("number"==b)return this.processor.add(function(b){var c=this.$host();return c._.limit=c._.limit||a,c._.taken>c._.limit?this.$break():this.$continue(b)});throw"TypeError: take argument must be function or number"},d.prototype.skip=function(a){if("number"==typeof a)return this.processor.add(function(b){var c=this.$host();return c._.emitted<=a?void this.$break():this.$continue(b)});throw"TypeError: skip argument must be only number"},d.prototype.mask=function(a){return"string"!=typeof a?this.map(a):this.process.add(function(){var b=/{{\s*[\w\.]+\s*}}/g;return this.$continue(a.replace(b,function(a){return e[a.slice(2,-2)]}))})},d.prototype.debounce=function(a){if("number"==typeof a)return this.addProcess(function(b){var c=this,d=this.$host();clearTimeout(d._.dbtimer),d._.dbtimer=setTimeout(function(){delete d._.dbtimer,c.$unlock(),c.$continue(b)},a),this.$lock()});throw"TypeError: argument of debounce must be a number of ms."},d.prototype.getCollected=function(a){if("number"==typeof a)return this.addProcess(function(){var b=this,c=this.$host();c._.timer||(c._.collectionStart=c._.fired-1,c._.timer=setTimeout(function(){var a=c._.history.slice(c._.collectionStart,c._.fired);delete c._.timer,b.$unlock(),b.$continue(a)},a),this.$lock())});throw"TypeError: getCollected of debounce must be a number of ms."}});